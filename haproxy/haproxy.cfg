global
    log stdout format raw local0
    maxconn 4096
    user haproxy
    group haproxy
    daemon

    # Optimisations SSL/TLS
    ssl-default-bind-ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  forwardfor
    option  http-server-close
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http

# Page de statistiques HAProxy
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
    stats auth admin:admin

# Frontend HTTP (redirection vers HTTPS en production)
frontend http_frontend
    bind *:80
    mode http
    
    # Rediriger vers HTTPS en production
    # redirect scheme https code 301 if !{ ssl_fc }
    
    # ACLs pour router le trafic vers les microservices
    acl is_appointments path_beg /api/appointments
    acl is_patients path_beg /api/patients
    acl is_documents path_beg /api/documents
    acl is_invoices path_beg /api/invoices
    acl is_billing path_beg /api/billing
    acl is_api path_beg /api
    
    # Router vers les microservices appropriés
    use_backend rdv_backend if is_appointments
    use_backend patient_backend if is_patients
    use_backend documents_backend if is_documents
    use_backend facturation_backend if is_invoices or is_billing
    use_backend info_backend if is_api
    
    # Default: serve frontend app
    default_backend frontend_app

# Frontend HTTPS (décommenter en production avec certificats)
# frontend https_frontend
#     bind *:443 ssl crt /usr/local/etc/haproxy/certs/medisecure.pem
#     mode http
#     
#     # Headers de sécurité
#     http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
#     http-response set-header X-Frame-Options "SAMEORIGIN"
#     http-response set-header X-Content-Type-Options "nosniff"
#     http-response set-header X-XSS-Protection "1; mode=block"
#     
#     acl is_api path_beg /api
#     use_backend backend_api if is_api
#     default_backend frontend_app

# Backend pour le Service RDV (Flask)
backend rdv_backend
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200,404
    
    retries 3
    timeout server 30s
    timeout connect 5s
    
    http-request set-header X-Forwarded-Port %[dst_port]
    http-request add-header X-Forwarded-Proto https if { ssl_fc }
    
    server rdv1 service-rdv:8002 check inter 2000ms rise 2 fall 3
    # Pour scaling: décommenter et ajuster
    # server rdv2 service-rdv-2:8002 check inter 2000ms rise 2 fall 3

# Info backend - returns a simple message
backend info_backend
    mode http
    http-request return status 200 content-type "application/json" string '{"status":"ok","message":"MediSecure API Gateway","version":"1.0","services":{"patients":"/api/patients","appointments":"/api/appointments","documents":"/api/documents","billing":"/api/billing"},"docs":{"documents":"http://localhost:8003/docs","billing":"http://localhost:8004/docs"}}'

# Backend pour le Service Patient (Django)
backend patient_backend
    mode http
    balance roundrobin
    option httpchk GET /admin/
    http-check expect status 200,302
    
    retries 3
    timeout server 30s
    timeout connect 5s
    
    http-request set-header X-Forwarded-Port %[dst_port]
    http-request add-header X-Forwarded-Proto https if { ssl_fc }
    
    server patient1 service-patient:8001 check inter 2000ms rise 2 fall 3
    # Pour scaling: décommenter et ajuster
# Backend pour le Service Documents (FastAPI)
backend documents_backend
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    retries 3
    timeout server 30s
    timeout connect 5s
    
    http-request set-header X-Forwarded-Port %[dst_port]
    http-request add-header X-Forwarded-Proto https if { ssl_fc }
    
    server documents1 service-documents:8003 check inter 2000ms rise 2 fall 3
    
# Backend pour le Service Facturation (FastAPI)
backend facturation_backend
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    retries 3
    timeout server 30s
    timeout connect 5s
    
    http-request set-header X-Forwarded-Port %[dst_port]
    http-request add-header X-Forwarded-Proto https if { ssl_fc }
    
    server facturation1 service-facturation:8004 check inter 2000ms rise 2 fall 3
    # Pour scaling: décommenter et ajuster
    # server facturation2 service-facturation-2:8004 check inter 2000ms rise 2 fall 3

# Backend pour le Frontend React
backend frontend_app
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200
    
    # Configuration de retry
    retries 3
    timeout server 30s
    
    # Server frontend
    server frontend1 medisecure-frontend:3000 check inter 2000ms rise 2 fall 3

# Backend pour RabbitMQ Management (commenté - pas utilisé)
# backend rabbitmq_management
#     mode http
#     balance roundrobin
#     server rabbitmq1 medisecure-rabbitmq:15672 check

# Configuration de rate limiting (optionnel)
# frontend http_frontend
#     stick-table type ip size 100k expire 30s store http_req_rate(10s)
#     http-request track-sc0 src
#     http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }
